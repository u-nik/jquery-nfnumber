/**
 * @author Niklas Funke <niklas.funke@gmail.com>
 * @date: 16.03.12
 * @version 0.4
 * @license MIT license
 */
(function(a){var b={precision:2,step:0,max:Math.pow(2,50),min:-Math.pow(2,50),decsign:".",seperator:"",shiftmulti:100,initformat:true,prefix:"",suffix:"",formmode:"raw",change:null,update:null,create:function(){},destroy:function(){},reachmax:null,reachmin:null};var c={reachedMax:false,reachedMin:false,invalidValue:0,keyupEvent:false};var d={init:function(c){var d=a(this);var g=a.extend({},b,c);e.setStep(g);e.destroy.call(this);d.on("change.nfnumber",f.change);d.on("keydown.nfnumber",f.keydown);d.on("destroy.nfnumber",g,g.destroy);d.on("keyup.nfnumber",f.keyup);d.each(function(b,c){var d=a(c),f={hidden:null};if(g.formmode=="raw"){var h=a(document.createElement("input")).attr({type:"hidden",name:d.attr("name"),value:d.val()});f.hidden=h;d.after(h)}f=a.extend({},g,d.data(),f);e.setStep(f);d.data("nfnumber",f)});if(g.initformat){d.trigger("change.nfnumber",true)}if(typeof g.create=="function"){g.create.call(this,g)}return this},destroy:function(){a(this).trigger("destroy.nfnumber");e.destroy.call(this);return this},value:function(b){var c=a(this);var d=c.data("nfnumber");if(d!=undefined){if(b!=undefined){if(d.formmode!="raw"){b=e.toFloat(b,d)}e.changeValue(c,b,d);return this}return d.hidden!=null?d.hidden.val():c.val()}else{if(b!=undefined){c.val(b);return this}return c.val()}}};var e={destroy:function(){var b=a(this);b.each(function(b,c){var e=a(c);var f=e.data("nfnumber");if(f!=undefined&&f.hidden!=null){var g=f.hidden;e.attr("name",g.attr("name")).val(g.val());e.getNumber=function(){return d.toFloat(this.value)};g.remove();e.removeData("nfnumber")}});b.off(".nfnumber",f.change)},setStep:function(a){if(a.step==0&&a.precision>0){a.step=1/Math.pow(10,a.precision)}},replace:function(a,b,c){return c.split(a).join(b)},round:function(a,b){var c=Math.pow(10,b);var d=a*c;d=Math.round(d);d/=c;a=Math.round(a*c)/c;return a},normalize:function(a,b){c.reachedMax=false;c.reachedMin=false;var d=a/b.step;d=e.round(d,b.precision);d=Math.ceil(d);a=d*b.step;var f=a;a=Math.min(a,b.max);a=Math.max(a,b.min);if(f<a){c.reachedMin=true;c.invalidValue=f}else if(f>a){c.reachedMax=true;c.invalidValue=f}return a},prepandZeros:function(a,b){while(a.length<b){a="0"+a}return a},toString:function(a,b){var c=b.precision,d=[],f,g,h,i,j,k=1e3;g=a<0;a=Math.abs(a);j=parseInt(a);if(c>0){i=""+Math.round((a-j)*Math.pow(10,c));i=e.prepandZeros(i,c)}while(j>0){f=j/k;f=""+Math.round((f-parseInt(f))*k);if(j>=k){f=e.prepandZeros(f,3)}d[d.length]=f;j=parseInt(j/k)}if(d.length==0){h="0"}else{h=d.reverse().join(b.seperator)}if(c>0){h+=b.decsign+i}return b.prefix+(g?"-":"")+h+b.suffix},toFloat:function(b,c){if(typeof b=="string"){if(c.prefix!=""){b=e.replace(c.prefix,"",b)}if(c.suffix!=""){b=e.replace(c.suffix,"",b)}if(c.seperator!=""&&b.indexOf(c.seperator)!=-1){b=e.replace(c.seperator,"",b)}if(c.decsign!="."&&b.indexOf(c.decsign)!=-1){b=e.replace(c.decsign,".",b)}}else{b="0"}var d=parseFloat(b);if(d==Number.NaN){a.error("Invalid Number: "+b);return 0}return d},changeValue:function(a,b,d){if(d==undefined){d=a.data("nfnumber")}b=e.normalize(b,d);if(d.formmode=="raw"){d.hidden.val(b)}a.val(e.toString(b,d));if(c.reachedMax&&d.reachmax!=null){d.reachmax.call(a,b,c.invalidValue,d)}else if(c.reachedMin&&d.reachmin!=null){d.reachmin.call(a,b,c.invalidValue,d)}return b},fireUpdateEvent:function(a,b,c){if(typeof c.update=="function"){c.update.call(a,b,c)}}};var f={change:function(b,c){var d=a(this),f;var g=d.data("nfnumber");if(c!=undefined&&g.formmode=="raw"){f=Math.max(parseFloat(d.val()),g.min)}else{f=e.toFloat(d.val(),g)}if(typeof g.change=="function"){g.change.call(d,f,g)}f=e.changeValue(d,f,g);if(c==undefined){e.fireUpdateEvent(d,f,g)}return false},keyup:function(){if(c.keyupEvent){var b=a(this);var d=b.data("nfnumber");var f=e.toFloat(b.val(),d);e.fireUpdateEvent(b,f,d);c.keyupEvent=false}return true},keydown:function(b){var d=a(this);var f=d.data("nfnumber");var g=e.toFloat(d.val(),f);var h=g,i=false,j=b.which,k=b.shiftKey;switch(j){case 38:if(k){g=g+f.shiftmulti*f.step}else{g=g+f.step}g=e.round(g,f.precision);break;case 40:if(k){g=g-f.shiftmulti*f.step}else{g=g-f.step}g=e.round(g,f.precision);break;case 32:if(!k){g=f.min!=Number.MIN_VALUE?f.min:0}else{g=f.max!=Number.MAX_VALUE?f.max:0}break;case 8:case 9:case 13:case 35:case 36:case 37:case 39:case 46:case 107:case 109:return true;default:if(!k){if(j>=48&&j<=57){return true}else if(j>=96&&j<=105){return true}else if(j==110||j==188){return true}else if(j==190||j==189){return true}}return false}if(g!=h){if(typeof f.change=="function"){f.change.call(d,g,f)}e.changeValue(d,g,f);c.keyupEvent=true}return i}};a.fn.nfNumber=function(b){if(d[b]){return d[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return d.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.nfnumber")}return this}})(jQuery)